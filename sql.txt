-- COUNT only; adjust range if volume > 1M/day
SELECT
  SUM(CASE WHEN promo_code IS NULL OR promo_code='' THEN 1 ELSE 0 END) AS actions_without_code,
  SUM(CASE WHEN promo_code IS NOT NULL AND promo_code<>'' THEN 1 ELSE 0 END) AS actions_with_code,
  COUNT(*) AS total_actions
FROM conversion_fact
WHERE advertiser_id = 30720
  AND event_datetime >= '2025-10-01' AND event_datetime < '2025-11-01';


SELECT UPPER(TRIM(promo_code)) AS promo_code_norm, COUNT(*) AS actions
FROM conversion_fact
WHERE advertiser_id = 30720
  AND event_datetime >= '2025-10-01' AND event_datetime < '2025-11-01'
  AND promo_code IS NOT NULL AND promo_code <> ''
GROUP BY 1
ORDER BY actions DESC;


/* DRAFT â€“ duplicates by OID + action_tracker */
WITH x AS (
  SELECT oid, action_tracker_id, COUNT(*) AS c
  FROM conversion_fact
  WHERE advertiser_id = 30720
    AND event_datetime >= '2025-10-01' AND event_datetime < '2025-11-01'
  GROUP BY 1,2
)
SELECT SUM(CASE WHEN c>1 THEN c-1 ELSE 0 END) AS duplicate_rows,
       COUNT(*) AS unique_order_rows
FROM x;



SELECT r.ref_type, COUNT(*) AS actions
FROM action_fact f
LEFT JOIN ref_type_dim r ON r.id = f.ref_type_dim_id
WHERE f.advertiser_id = 30720
  AND f.action_datetime >= '2025-10-01' AND f.action_datetime < '2025-11-01'
  AND r.ref_type = 'PROMOCODE'
GROUP BY 1;


SELECT code, ircm_campaign_id, status, doe, dlu
FROM ircm_promocode
WHERE ircm_campaign_id IN (<Motatos campaign id(s)>)
LIMIT 1000;
