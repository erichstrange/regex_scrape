/* Find the two Sept-2025 credit lines for Chime/Nerdwallet */
SELECT
  li.id,
  li.iracct_recipientgenerated_invoice_id AS rgi_id,
  li.iram_publisher_id,
  li.service_provider_legal_entity_id,
  li.txn_code,
  li.description,
  li.num_actions            AS quantity,
  li.adv_net_amount         AS amount_adv,
  li.adv_net_amount_currency AS currency_adv,
  li.event_month, li.event_year,
  li.finance_invoice_id
FROM iracct.iracct_campaign_recipient_generated_lineitem li
WHERE li.iram_advertiser_id = 5819706               -- Chime
  AND (li.iram_publisher_id = 170911
       OR li.service_provider_legal_entity_id = 170911)  -- Nerdwallet identifiers
  AND li.event_year  = 2025
  AND li.event_month = 9
  AND li.adv_net_amount IN (-13.50, -45780.00)
ORDER BY li.adv_net_amount;


SELECT
  li.id, li.iracct_recipientgenerated_invoice_id AS rgi_id,
  li.iram_publisher_id, li.service_provider_legal_entity_id,
  li.txn_code, li.description, li.num_actions AS quantity,
  li.adv_net_amount AS amount_adv, li.adv_net_amount_currency AS currency_adv,
  li.event_month, li.event_year, li.finance_invoice_id
FROM iracct.iracct_campaign_recipient_generated_lineitem li
WHERE li.iram_advertiser_id = 5819706
  AND (li.iram_publisher_id = 170911 OR li.service_provider_legal_entity_id = 170911)
  AND li.event_year  = 2025
  AND li.event_month = 9
  AND (
       li.description LIKE 'Advertising Media Partner Payout%' OR
       li.description LIKE 'Bonuses, Make Goods and Paid Placements%'
      )
ORDER BY li.adv_net_amount;





SELECT
  rgi.id,
  rgi.iram_publisher_id,
  rgi.service_provider_legal_entity_id,
  rgi.iram_advertiser_id,
  rgi.sequence_number,
  rgi.year, rgi.month,
  rgi.date_generated,
  rgi.state, rgi.due_date
FROM iracct.iracct_recipientgenerated_invoice rgi
WHERE rgi.id = :RGI_ID_FROM_STEP_1;



SELECT
  rgi.id,
  rgi.iram_publisher_id,                 -- expect 170911
  rgi.service_provider_legal_entity_id,
  rgi.iram_advertiser_id,                -- 5819706
  rgi.sequence_number,                   -- expect 3482
  rgi.year, rgi.month, rgi.date_generated, rgi.state
FROM iracct.iracct_recipientgenerated_invoice rgi
WHERE rgi.iram_publisher_id   = 170911
  AND rgi.sequence_number     = 3482
  AND rgi.iram_advertiser_id  = 5819706
ORDER BY rgi.date_generated DESC
LIMIT 5;



SELECT
  CASE
    WHEN li.description LIKE 'Advertising Media Partner Payout%' THEN 'CPC'
    WHEN li.description LIKE 'Bonuses, Make Goods and Paid Placements%' THEN 'No Event Type / Other Costs'
    ELSE COALESCE(li.txn_code,'(unclassified)')
  END AS statement_bucket,
  li.description,
  li.num_actions AS quantity,
  li.adv_net_amount AS amount_adv,
  li.adv_net_amount_currency AS currency
FROM iracct.iracct_campaign_recipient_generated_lineitem li
WHERE li.iracct_recipientgenerated_invoice_id = :RGI_ID_FROM_STEP_1
ORDER BY statement_bucket;
