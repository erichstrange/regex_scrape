-- REI Product Boost â€“ Clean Audit CSV for AP/Jithin
-- DS: r_ds_iraction_sharded

WITH qualifying AS (
  /* Inline the boost-eligible (oid, sku) you found in IRDW, plus their category path for clarity */
  SELECT 'A385560474' AS oid, '2399930003' AS sku, 'Sporting Goods > Outdoor Recreation > Winter Sports & Activities > Skiing & Snowboarding > Ski Bindings' AS catalog_category_path
  UNION ALL SELECT 'A385595006','2130310001','Sporting Goods > Outdoor Recreation > Winter Sports & Activities > Skiing & Snowboarding > Ski Bindings'
  UNION ALL SELECT 'A385443249','2404130003','Sporting Goods > Outdoor Recreation > Winter Sports & Activities > Skiing & Snowboarding > Skis'
  UNION ALL SELECT 'A385633257','2389770002','Sporting Goods > Outdoor Recreation > Winter Sports & Activities > Skiing & Snowboarding > Snowboards'
  UNION ALL SELECT 'A385643176','2397930003','Sporting Goods > Outdoor Recreation > Winter Sports & Activities > Skiing & Snowboarding > Ski & Snowboard Bags'
  UNION ALL SELECT 'A385648053','2396240003','Sporting Goods > Outdoor Recreation > Winter Sports & Activities > Skiing & Snowboarding > Ski Boots'
  UNION ALL SELECT 'A385659112','1996680001','Sporting Goods > Outdoor Recreation > Winter Sports & Activities > Skiing & Snowboarding > Ski & Snowboard Wax'
  UNION ALL SELECT 'A385710403','2399920003','Sporting Goods > Outdoor Recreation > Winter Sports & Activities > Skiing & Snowboarding > Ski Bindings'
  UNION ALL SELECT 'A385720943','2255980003','Sporting Goods > Outdoor Recreation > Winter Sports & Activities > Skiing & Snowboarding > Ski Boots'
),
base AS (
  /* Pull the original itemized records for those nine OIDs */
  SELECT
    advertiser_id,
    campaign_id,
    publisher_id               AS media_partner_id,
    action_id,
    oid,
    action_date                AS action_datetime_utc,
    sku,
    quantity,
    adv_saleamt                AS item_adv_sale_amount,
    adv_currency,
    payout_trace
  FROM irac_action2
  WHERE advertiser_id = 3622523
    AND campaign_id   = 17195
    AND oid IN ('A385560474','A385595006','A385443249','A385633257','A385643176',
                'A385648053','A385659112','A385710403','A385720943')
    /* Ignore negative adjustment rows; we want the net sale line(s) for re-submission */
    AND NOT (quantity < 0 OR adv_saleamt < 0)
)
SELECT
  b.media_partner_id,
  b.action_id,
  b.oid,
  CONCAT(b.oid, '_c')                            AS new_oid_for_resubmit,
  b.action_datetime_utc,
  b.sku,
  b.quantity,
  b.item_adv_sale_amount,
  b.adv_currency,
  q.catalog_category_path,
  CASE WHEN q.oid IS NOT NULL THEN 1 ELSE 0 END  AS boost_category_flag,
  CASE WHEN q.oid IS NOT NULL THEN ROUND(b.item_adv_sale_amount * 0.20, 2) END AS expected_boost_commission,
  4018                                          AS product_boost_campaign_id
FROM base b
LEFT JOIN qualifying q
  ON q.oid = b.oid AND q.sku = b.sku
ORDER BY b.action_datetime_utc, b.action_id, b.sku;
