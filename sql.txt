-- DS: r_ds_ods (or your ODS for ir_api_log)
SELECT
  DATE(doe) AS day,
  COUNT(*) AS submissions,
  SUM(CASE WHEN error_json IS NOT NULL THEN 1 ELSE 0 END) AS any_errors,
  SUM(CASE WHEN error_json LIKE '%OID_DUPLICATE%' THEN 1 ELSE 0 END) AS dup_oid,
  SUM(CASE WHEN error_json LIKE '%CONV_DUPLICATE%' THEN 1 ELSE 0 END) AS dup_conv
FROM ir_api_log
WHERE iram_account_id = 4984840
  AND type IN ('CONVERSION','CONVERSIONS')
  AND doe >= '2025-11-01' AND doe < '2025-11-18'
GROUP BY 1
ORDER BY 1;



SELECT
  DATE(doe) AS day,
  CASE
    WHEN error_json LIKE '%CONTRACT%' THEN 'IO/Contract'
    WHEN error_json LIKE '%TRACKER%' THEN 'Tracker'
    WHEN error_json LIKE '%MISSING%' THEN 'MissingParam'
    WHEN error_json LIKE '%CURRENCY%' THEN 'Currency'
    WHEN error_json LIKE '%UNAUTHORIZED%' OR error_json LIKE '%401%' THEN 'Auth'
    ELSE 'Other'
  END AS bucket,
  COUNT(*) AS cnt
FROM ir_api_log
WHERE iram_account_id = 4984840
  AND error_json IS NOT NULL
  AND doe >= '2025-11-01' AND doe < '2025-11-18'
GROUP BY 1,2
ORDER BY 1,3 DESC;



SELECT DATE(doe) AS day, COUNT(*) AS dup_oids
FROM ir_api_log
WHERE iram_account_id = 4984840
  AND error_json LIKE '%OID_DUPLICATE%'
  AND doe >= '2025-11-01' AND doe < '2025-11-18'
GROUP BY 1 ORDER BY 1;


-- DS: ircm
SELECT sc.iram_publisher_id, sc.ircm_campaign_id, iot.credit_group, sc.date_contract_start, sc.date_contract_end
FROM ircm_signedcontract sc
LEFT JOIN ircm_ioterms iot ON iot.id = sc.ircm_ioterms_id
WHERE sc.ircm_campaign_id = 22439
  AND (sc.date_contract_end IS NULL OR sc.date_contract_end >= '2025-11-11');


SELECT DATE_TRUNC('HOUR', event_datetime) AS hour, COUNT(*) AS convs
FROM conversion_fact
WHERE campaign_id = 22439
  AND event_datetime >= '2025-11-11' AND event_datetime < '2025-11-15'
GROUP BY 1 ORDER BY 1;
