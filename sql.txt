-- Header: Impactradius invoice for 170911-3482 (Nerdwallet) that feeds the SOI
SELECT
  iri.id,
  CONCAT(iri.legal_entity_id, '-', iri.sequence_number) AS invoice_number,
  iri.finance_invoice_id,
  iri.date_generated,
  iri.month, iri.year,
  iri.state
FROM iracct.iracct_impactradius_invoice AS iri
WHERE iri.legal_entity_id = 170911   -- Nerdwallet LE
  AND iri.sequence_number = 3482;    -- "...-3482"



-- Line items tied to the above invoice header
SELECT
  li.id,
  li.txn_code,
  li.description,
  li.num_actions,
  li.adv_net_amount, li.adv_net_amount_currency,
  li.mp_net_amount,  li.mp_net_amount_currency,
  li.event_month, li.event_year
FROM iracct.iracct_campaign_recipient_generated_lineitem AS li
JOIN iracct.iracct_impactradius_invoice AS iri
  ON li.finance_invoice_id = iri.finance_invoice_id
WHERE iri.legal_entity_id = 170911
  AND iri.sequence_number = 3482
  AND li.iram_advertiser_id = 5819706     -- Chime
ORDER BY li.id;





-- Header: Recipient-generated invoice, if present for this number
SELECT
  rgi.id,
  rgi.service_provider_legal_entity_id,
  rgi.sequence_number,
  rgi.iram_advertiser_id,
  rgi.iram_publisher_id,
  rgi.date_generated,
  rgi.month, rgi.year,
  rgi.state
FROM iracct.iracct_recipientgenerated_invoice AS rgi
WHERE rgi.service_provider_legal_entity_id = 170911
  AND rgi.sequence_number = 3482
  AND rgi.iram_advertiser_id = 5819706;

SELECT
  li.id,
  li.txn_code,
  li.description,
  li.num_actions,
  li.adv_net_amount, li.adv_net_amount_currency,
  li.mp_net_amount,  li.mp_net_amount_currency,
  li.event_month, li.event_year
FROM iracct.iracct_campaign_recipient_generated_lineitem AS li
WHERE li.iracct_recipientgenerated_invoice_id = :rgi_id   -- <-- from the header above
ORDER BY li.id;



SELECT *
FROM iracct.iracct_campaign_mp_funds_transfer
WHERE iram_advertiser_id = 5819706
  AND iram_publisher_id  = 170911
  AND doe BETWEEN '2025-11-01' AND '2025-11-10'
ORDER BY dlu DESC;
