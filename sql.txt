/* DRAFT - TS - Order Processing Latency Lookup (Internal Only)
   Datasource: r_ds_singlestore
   Table: datalake_irdwm.action_fact
*/

SELECT
    af.advertiser_id                                  AS advertiser_id,
    af.campaign_id                                    AS campaign_id,
    af.oid                                            AS oid,
    af.action_id                                      AS action_id,

    -- Event / click timestamp
    af.ref_datetime                                   AS ClickDateTime_UTC,

    -- When the action first hit our system
    af.action_datetime                                AS ConversionDateTime_UTC,

    -- When AP finished processing the action
    af.doe                                            AS APProcessedDateTime_UTC,

    -- When the action was last adjusted in AP (if ever)
    af.adj_datetime                                   AS LastAdjustmentDateTime_UTC,

    -- Latency between conversion event and AP processing
    TIMESTAMPDIFF(
        MINUTE,
        af.action_datetime,
        af.doe
    )                                                 AS APProcessingLatency_Minutes,

    -- Optional: latency from click to AP processing
    TIMESTAMPDIFF(
        MINUTE,
        af.ref_datetime,
        af.doe
    )                                                 AS ClickToAPProcessing_Minutes

FROM
    action_fact af
WHERE
    af.advertiser_id = :advertiser_id
    AND af.campaign_id = :campaign_id
    AND af.oid = :oid
    AND af.action_datetime BETWEEN :start_action_datetime AND :end_action_datetime

ORDER BY
    af.action_datetime DESC;
