-- Motatos programs mapped in conversion_fact
-- DACH  -> advertiser_id 6006417
-- Nordics -> advertiser_id 6006625

SELECT
  advertiser_id,
  /* action rows (may include API + pixel duplicates) */
  SUM(CASE WHEN promo_code IS NULL OR promo_code='' THEN 1 ELSE 0 END) AS action_rows_without_code,
  SUM(CASE WHEN promo_code IS NOT NULL AND promo_code<>'' THEN 1 ELSE 0 END) AS action_rows_with_code,
  COUNT(*) AS action_rows_total,

  /* apples-to-apples with "redemptions" = orders */
  COUNT(DISTINCT CASE WHEN promo_code IS NULL OR promo_code='' THEN oid END) AS oids_without_code,
  COUNT(DISTINCT CASE WHEN promo_code IS NOT NULL AND promo_code<>'' THEN oid END) AS oids_with_code,
  COUNT(DISTINCT oid) AS oids_total
FROM conversion_fact
WHERE advertiser_id IN (6006417, 6006625)
  AND event_datetime >= '2025-10-01' AND event_datetime < '2025-11-01'
GROUP BY advertiser_id
ORDER BY advertiser_id;



-- How many orders fired both API and pixel/mobile in Oct-2025
SELECT
  advertiser_id,
  COUNT(*) AS oids_with_api_and_pixel
FROM (
  SELECT advertiser_id, oid
  FROM conversion_fact
  WHERE advertiser_id IN (6006417, 6006625)
    AND event_datetime >= '2025-10-01' AND event_datetime < '2025-11-01'
    AND promo_code IS NOT NULL AND promo_code <> ''
  GROUP BY advertiser_id, oid
  HAVING COUNT(DISTINCT method) >= 2
) d
GROUP BY advertiser_id
ORDER BY advertiser_id;



-- Top codes by DISTINCT orders (not raw action rows)
SELECT
  advertiser_id,
  LOWER(promo_code) AS code_lower,
  COUNT(DISTINCT oid) AS orders_with_code
FROM conversion_fact
WHERE advertiser_id IN (6006417, 6006625)
  AND event_datetime >= '2025-10-01' AND event_datetime < '2025-11-01'
  AND promo_code IS NOT NULL AND promo_code <> ''
GROUP BY advertiser_id, LOWER(promo_code)
ORDER BY advertiser_id, orders_with_code DESC
LIMIT 200;



-- By day (for trend validation / cutover checks)
SELECT
  advertiser_id,
  DATE(event_datetime) AS day,
  LOWER(promo_code) AS code_lower,
  COUNT(DISTINCT oid) AS orders_with_code
FROM conversion_fact
WHERE advertiser_id IN (6006417, 6006625)
  AND event_datetime >= '2025-10-01' AND event_datetime < '2025-11-01'
  AND promo_code IS NOT NULL AND promo_code <> ''
GROUP BY advertiser_id, DATE(event_datetime), LOWER(promo_code)
ORDER BY advertiser_id, day, orders_with_code DESC
LIMIT 10000;
