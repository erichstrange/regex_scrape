-- Total clicks per day for Route One across all Fubo campaigns
SELECT 
  DATE_TRUNC('DAY', event_datetime) AS dt,
  COUNT(*) AS total_clicks
FROM click_fact
WHERE publisher_id = 6251546
  AND event_datetime >= '2025-10-19'
  AND event_datetime <  '2025-11-12'
GROUP BY 1
ORDER BY 1;


-- Inspect latest clicks (show reasons/flags)
SELECT
  event_datetime,
  campaign_id,
  method,
  classification,
  click_id,
  JSON_EXTRACT_STRING(json,'ruleName')       AS rule_name,
  JSON_EXTRACT_STRING(json,'blockingRule')   AS blocking_rule,
  JSON_EXTRACT_BIGINT(json,'orgdc')          AS datacenter_flag,
  landing_page_url_noquery                   AS landing_page
FROM click_fact
WHERE publisher_id = 6251546
  AND event_datetime >= '2025-10-19'
  AND event_datetime <  '2025-11-12'
ORDER BY event_datetime DESC
LIMIT 1000;


-- How many clicks were classified as duplicate/excluded/bot by campaign
SELECT
  cf.campaign_id,
  cf.publisher_id,
  SUM(CASE WHEN cf.classification = 'D' THEN 1 ELSE 0 END) AS duplicate_clicks,
  SUM(CASE WHEN cf.classification = 'E' THEN 1 ELSE 0 END) AS excluded_clicks,
  SUM(CASE WHEN cf.classification = 'B' THEN 1 ELSE 0 END) AS bot_clicks,
  SUM(IFNULL(JSON_EXTRACT_BIGINT(cf.json,'orgdc'),0))      AS datacenter_clicks,
  COUNT(*)                                                 AS total_clicks
FROM click_fact cf
WHERE cf.publisher_id = 6251546
  AND cf.event_datetime >= '2025-10-19'
  AND cf.event_datetime <  '2025-11-12'
  AND cf.classification IN ('D','E','U','B')
GROUP BY 1,2
ORDER BY total_clicks DESC;


-- Is this publisher being globally filtered?
SELECT *
FROM trkcfg.trkcfg_global_click_filter_config
WHERE publisher_id = 6251546;
