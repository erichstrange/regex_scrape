-- [VETTED] Promo codes for Creator campaigns 31202 & 31203
-- DS: r_ds_ircm
SELECT
  ircm_campaign_id,
  iram_publisher_id,
  date_last_assigned,
  end_date,
  LOWER(promo_code) AS code_lower,
  promo_code        AS code_original,
  state
FROM ircm_promocode
WHERE ircm_campaign_id IN (31202, 31203)
ORDER BY ircm_campaign_id, code_lower
LIMIT 1000;


-- [DRAFT] Distinct orders in Octâ€‘2025 using Creator promo codes
-- DS: singlestore
WITH creator_codes AS (
  SELECT DISTINCT LOWER(promo_code) AS code_lower
  FROM ircm_promocode
  WHERE ircm_campaign_id IN (31202, 31203)
)
SELECT
  advertiser_id,
  COUNT(DISTINCT oid) AS orders_with_creator_codes
FROM conversion_fact
WHERE advertiser_id IN (6006417, 6006625)  -- Motatos DACH + Nordics
  AND event_datetime >= '2025-10-01'
  AND event_datetime <  '2025-11-01'
  AND promo_code IS NOT NULL
  AND promo_code <> ''
  AND LOWER(promo_code) IN (SELECT code_lower FROM creator_codes)
GROUP BY advertiser_id
ORDER BY advertiser_id;


-- [DRAFT] Distinct orders with Creator promo + Creator campaign actions
-- DS: singlestore + r_ds_ircm / irac_action2
WITH creator_codes AS (...same as above...),
creator_oids AS (
  SELECT DISTINCT oid
  FROM irac_action2
  WHERE campaign_id IN (31202, 31203)
    AND action_date >= '2025-10-01'
    AND action_date <  '2025-11-01'
)
SELECT
  advertiser_id,
  COUNT(DISTINCT oid) AS creator_orders
FROM conversion_fact
WHERE advertiser_id IN (6006417, 6006625)
  AND event_datetime >= '2025-10-01'
  AND event_datetime <  '2025-11-01'
  AND promo_code IS NOT NULL AND promo_code <> ''
  AND LOWER(promo_code) IN (SELECT code_lower FROM creator_codes)
  AND oid IN (SELECT oid FROM creator_oids)
GROUP BY advertiser_id;
