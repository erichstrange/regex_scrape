SELECT
  pd.publisher_name,
  count(*) as total_clicks,
  sum(case when classification = 'D' then 1 else 0 end) as duplicate_clicks,
  sum(case when classification = 'E' then 1 else 0 end) as excluded_clicks,
  sum(case when JSON_UNQUOTE(JSON_EXTRACT(cf.data, '$.orgdc')) = 'DATACENTER' then 1 else 0 end) as datacenter_clicks,
  sum(case when classification = 'B' then 1 else 0 end) as bot_clicks,
  ROUND((duplicate_clicks / total_clicks) * 100, 2) AS percent_duplicate_clicks,
  ROUND((excluded_clicks / total_clicks) * 100, 2) AS percent_excluded_clicks,
  ROUND((datacenter_clicks / total_clicks) * 100, 2) AS percent_datacenter_clicks,
  ROUND((bot_clicks / total_clicks) * 100, 2) AS percent_bot_clicks
FROM click_fact cf
JOIN publisher_dim pd ON cf.publisher_id = pd.publisher_id
WHERE cf.event_datetime BETWEEN current_date - interval 7 day AND current_date
  AND cf.campaign_id IN (56738)
  AND classification in ('D','E','U','B')
GROUP BY 1
ORDER BY total_clicks DESC;
