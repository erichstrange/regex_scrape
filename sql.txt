-- r_ds_ods
-- DRAFT (peer review welcome): initial wide-net search over API/Kong logs.
-- Looks for any calls touching Prospects/Proposals/Recruit/Discover.
SELECT
  doe,
  iram_account_id,
  http_method,
  endpoint,
  response_code,
  -- Try to pull common fields if payload is JSON:
  JSON_UNQUOTE(JSON_EXTRACT(payload, '$.source'))                         AS json_source,
  JSON_UNQUOTE(JSON_EXTRACT(payload, '$.addedBy.username'))               AS json_added_by_username,
  JSON_UNQUOTE(JSON_EXTRACT(payload, '$.addedBy.userId'))                 AS json_added_by_user_id,
  JSON_UNQUOTE(JSON_EXTRACT(payload, '$.createdBy'))                      AS json_created_by,
  JSON_UNQUOTE(JSON_EXTRACT(payload, '$.prospectId'))                     AS json_prospect_id,
  JSON_UNQUOTE(JSON_EXTRACT(payload, '$.partnerId'))                      AS json_partner_id,
  payload
FROM ir_api_log
WHERE iram_account_id = 5475947
  AND doe >= '2025-09-01' AND doe < '2025-11-01'
  AND LOWER(endpoint) REGEXP 'prospect|proposal|recruit|discover'
  -- Optional: focus on create/assign/mark-as-prospect actions
  -- AND http_method IN ('POST','PUT','PATCH')
ORDER BY doe DESC
LIMIT 2000;



-- r_ds_ods
-- DRAFT (peer review welcome): look for “source":"other” in the payload
SELECT
  doe, iram_account_id, http_method, endpoint, response_code,
  JSON_UNQUOTE(JSON_EXTRACT(payload, '$.source')) AS json_source,
  JSON_UNQUOTE(JSON_EXTRACT(payload, '$.addedBy.username')) AS json_added_by_username,
  JSON_UNQUOTE(JSON_EXTRACT(payload, '$.partnerId')) AS json_partner_id,
  payload
FROM ir_api_log
WHERE iram_account_id = 5475947
  AND doe >= '2025-10-27' AND doe < '2025-10-31'
  AND (LOWER(endpoint) LIKE '%prospect%' OR LOWER(endpoint) LIKE '%proposal%')
  AND LOWER(payload) LIKE '%"source":"other"%'
ORDER BY doe DESC
LIMIT 1000;


-- iram (Query Runner)
SELECT u.id, ce.username, ce.email, ce.firstname, ce.lastname, u.state,
       ce.lastlogin_date, ce.doe, ce.dlu, ce.uoe, ce.ulu
FROM iram_usership u
JOIN core_estaleauser ce ON u.account_user_id = ce.id
WHERE u.irAccount_Id = '5475947'
ORDER BY ce.lastlogin_date DESC;



-- iram (Query Runner)
SELECT *
FROM irwsapi_webservice_user
WHERE iram_account_id IN (5475947);
