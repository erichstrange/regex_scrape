/* DRAFT — Header for RGI 170911-3482 (Chime 5819706, Nerdwallet 170911) */
SELECT
  rgi.id,
  CONCAT(rgi.service_provider_legal_entity_id, '-', rgi.sequence_number) AS invoice_number,
  rgi.iram_advertiser_id,
  rgi.iram_publisher_id,
  rgi.year,
  rgi.month,
  rgi.date_generated,
  rgi.state,
  rgi.due_date
FROM iracct.iracct_recipientgenerated_invoice rgi
WHERE rgi.iram_advertiser_id = 5819706      -- Chime
  AND rgi.service_provider_legal_entity_id = 170911  -- Nerdwallet LE
  AND rgi.sequence_number = 3482;            -- the “-3482” piece


/* DRAFT — Line items for that RGI (expect exactly 2 rows: CPC –13.50, Make-good –45,780.00) */
SELECT
  li.*  -- keep * to see available columns; we’ll read description/amount/event_type fields as present
FROM iracct.iracct_campaign_recipient_generated_lineitem li
JOIN iracct.iracct_recipientgenerated_invoice rgi
      ON li.recipient_generated_invoice_id = rgi.id  -- if this column name 404s, use the fallback below
WHERE rgi.iram_advertiser_id = 5819706
  AND rgi.service_provider_legal_entity_id = 170911
  AND rgi.sequence_number = 3482
ORDER BY li.line_number;

/* Fallback join key (some envs): li.recipientgeneratedinvoice_id */
-- JOIN iracct.iracct_recipientgenerated_invoice rgi
--   ON li.recipientgeneratedinvoice_id = rgi.id





/* DRAFT — Header by invoice_number literal */
SELECT
  iri.id,
  iri.invoice_number,
  iri.iram_advertiser_id,
  iri.iram_publisher_id,
  iri.date_generated,
  iri.state
FROM iracct.iracct_impactradius_invoice iri
WHERE iri.invoice_number = '170911-3482'
  AND iri.iram_advertiser_id = 5819706;

/* DRAFT — Line items for that invoice id */
SELECT
  l.*
FROM iracct.iracct_impactradius_invoice_lineitem l
WHERE l.iracct_impactradius_invoice_id = (
  SELECT iri.id
  FROM iracct.iracct_impactradius_invoice iri
  WHERE iri.invoice_number = '170911-3482'
    AND iri.iram_advertiser_id = 5819706
)
ORDER BY l.line_number;



/* Redshift — count non-payable CPC clicks that locked in Oct for Sept activity */
SELECT
  COUNT(*) AS nonpayables_sept_locked_oct
FROM click_fact
WHERE advertiser_id = 5819706          -- Chime
  AND publisher_id  = 170911            -- Nerdwallet
  AND campaign_id   = 28165
  AND event_datetime >= '2025-09-01' AND event_datetime < '2025-10-01'
  AND cpc_locking_date >= '2025-10-01' AND cpc_locking_date < '2025-11-01'
  AND cpc_payable = 0;
