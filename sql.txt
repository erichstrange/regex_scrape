-- REI Product Boost â€“ Final Audit CSV (category-matching items only)
-- DS: datalake_irdwm  (IRDW/Redshift)

WITH items AS (
  SELECT
    af.advertiser_id,
    af.campaign_id,
    af.publisher_id                                AS media_partner_id,
    af.action_id,
    af.oid,
    af.action_datetime                             AS action_datetime_utc,
    aif.sku,
    aif.quantity,
    COALESCE(asd.original_format_category, asd.category) AS catalog_category_path,
    asd.catalog_id,
    asd.catalog_item_id
  FROM datalake_irdwm.action_fact        af
  JOIN datalake_irdwm.action_item_fact   aif ON aif.action_id = af.action_id
  LEFT JOIN datalake_irdwm.action_sku_dim asd ON asd.id       = aif.sku_dim_id
  WHERE af.advertiser_id  = 3622523                 -- REI
    AND af.campaign_id    = 17195                   -- Program
    AND af.publisher_id IN (5879071,2536211,2850304,6213049,2022587) -- 5 partners
    AND af.action_datetime >= TIMESTAMP '2025-10-14 00:00:00+00'
    AND af.action_datetime <  TIMESTAMP '2025-10-17 19:00:00+00'
    AND (
      asd.original_format_category LIKE 'Sporting Goods%> Outdoor Recreation%> Winter Sports & Activities%> Skiing & Snowboarding%'
      OR asd.original_format_category LIKE 'Sporting Goods%> Outdoor Recreation%> Winter Sports & Activities%> Snowshoeing%'
      OR asd.original_format_category LIKE 'Apparel & Accessories%> Clothing%> Outerwear%> Snow Pants & Suits%'
      OR asd.original_format_category LIKE 'Vehicles & Parts%> Vehicle Parts & Accessories%> Vehicle Storage & Cargo%> Motor Vehicle Carrying Racks%> Vehicle Ski & Snowboard Racks%'
    )
),
pubs AS (
  SELECT publisher_id, COALESCE(name, trading_name, CAST(publisher_id AS VARCHAR)) AS media_partner_name
  FROM datalake_irdwm.publisher_dim
)
SELECT
  i.advertiser_id,
  i.campaign_id,
  i.media_partner_id,
  p.media_partner_name,
  i.action_id,
  i.oid,
  i.action_datetime_utc,
  i.sku,
  i.quantity,
  i.catalog_category_path,
  i.catalog_id,
  i.catalog_item_id,
  CASE WHEN i.quantity > 0 THEN TRUE ELSE FALSE END              AS eligible_for_remediation,
  CASE WHEN i.quantity > 0 THEN NULL ELSE 'quantity<=0 (adjustment/no-op)' END AS remediation_note
FROM items i
LEFT JOIN pubs p ON p.publisher_id = i.media_partner_id
ORDER BY i.action_datetime_utc, i.action_id, i.sku;
